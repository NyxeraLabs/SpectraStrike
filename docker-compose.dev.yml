# Copyright (c) 2026 NyxeraLabs
# Author: José María Micoli
# Licensed under BSL 1.1
# Change Date: 2033-02-22 -> Apache-2.0
#
# You may:
# Study
# Modify
# Use for internal security testing
#
# You may NOT:
# Offer as a commercial service
# Sell derived competing products

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: spectrastrike_app
    init: true
    working_dir: /app
    user: "1000:1000"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/app/src
      - TELEMETRY_BROKER=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5671
      - RABBITMQ_USER=spectra
      - RABBITMQ_SSL=true
      - RABBITMQ_SSL_CA_FILE=/app/docker/pki/ca.crt
      - RABBITMQ_SSL_CERT_FILE=/app/docker/pki/app/client.crt
      - RABBITMQ_SSL_KEY_FILE=/app/docker/pki/app/client.key
      - RABBITMQ_VHOST=/
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_SSL=true
      - POSTGRES_SSLMODE=verify-full
      - POSTGRES_SSL_ROOT_CERT=/app/docker/pki/ca.crt
      - POSTGRES_SSL_CERT_FILE=/app/docker/pki/app/client.crt
      - POSTGRES_SSL_KEY_FILE=/app/docker/pki/app/client.key
      - REDIS_HOST=redis
      - REDIS_PORT=6380
      - REDIS_TLS=true
      - REDIS_TLS_CA_FILE=/app/docker/pki/ca.crt
      - REDIS_TLS_CERT_FILE=/app/docker/pki/app/client.crt
      - REDIS_TLS_KEY_FILE=/app/docker/pki/app/client.key
      - MSF_RPC_HOST=metasploit.remote.operator
      - MSF_RPC_PORT=55553
      - MSF_RPC_SSL=true
      - MSF_MANUAL_BASE_URL=https://metasploit.remote.operator:5443
      - COBALTSTRIKE_HOST=cobalt.remote.operator
      - COBALTSTRIKE_PORT=50050
    volumes:
      - ./:/app:rw
    command: ["sh", "-c", "python -m pkg.orchestrator.run_simulations --test && sleep infinity"]
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "python", "-c", "print('ok')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - core_net
      - edge_net

  ui-web:
    build:
      context: ./ui/web
      dockerfile: Dockerfile
    container_name: spectrastrike_ui_web
    init: true
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - UI_ALLOWED_ORIGINS=https://localhost:${HOST_PROXY_TLS_PORT:-18443},https://127.0.0.1:${HOST_PROXY_TLS_PORT:-18443},http://localhost:3000,http://127.0.0.1:3000
      - SPECTRASTRIKE_LEGAL_ACCEPTANCE_PATH=/var/lib/spectrastrike/legal/acceptance.json
    volumes:
      - ui_legal_data:/var/lib/spectrastrike
    depends_on:
      app:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "node", "-e", "const http=require('http');const os=require('os');const targets=[{host:os.hostname(),port:3000,path:'/ui'},{host:'127.0.0.1',port:3000,path:'/ui'}];let i=0;const ok=s=>s>=200&&s<400;const probe=()=>{if(i>=targets.length){process.exit(1);return;}const req=http.get(targets[i],res=>{res.resume();process.exit(ok(res.statusCode||0)?0:1);});req.on('error',()=>{i+=1;probe();});};probe();"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - core_net

  ui-admin:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: spectrastrike_ui_admin
    init: true
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/app/src
      - UI_ADMIN_API_BASE_URL=http://ui-web:3000/ui/api
    command: ["python", "-m", "pkg.ui_admin.shell", "--base-url", "http://ui-web:3000/ui/api"]
    depends_on:
      ui-web:
        condition: service_healthy
    profiles: ["admin"]
    stdin_open: true
    tty: true
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    security_opt:
      - no-new-privileges:true
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - core_net

  rabbitmq:
    image: rabbitmq:3.13.7-management
    container_name: spectrastrike_rabbitmq
    init: true
    environment:
      - RABBITMQ_BOOT_USER_FILE=/run/secrets/rabbitmq_user
      - RABBITMQ_BOOT_PASS_FILE=/run/secrets/rabbitmq_password
      - RABBITMQ_CONFIG_FILE=/etc/rabbitmq/rabbitmq
    ports:
      - "127.0.0.1:${HOST_RABBITMQ_MGMT_PORT:-15672}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./docker/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./docker/scripts/start_rabbitmq.sh:/usr/local/bin/start-rabbitmq.sh:ro
      - ./docker/pki:/etc/rabbitmq/pki:ro
    command: ["/usr/local/bin/start-rabbitmq.sh"]
    secrets:
      - rabbitmq_user
      - rabbitmq_password
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 20s
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - core_net

  postgres:
    image: postgres:16.4-alpine
    container_name: spectrastrike_postgres
    init: true
    environment:
      - POSTGRES_DB=spectrastrike
      - POSTGRES_USER_FILE=/run/secrets/postgres_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    ports:
      - "127.0.0.1:${HOST_DB_PORT:-15432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/pki:/etc/postgresql/pki:ro
      - ./docker/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./docker/scripts/start_postgres_tls.sh:/usr/local/bin/start-postgres-tls.sh:ro
    command: ["/usr/local/bin/start-postgres-tls.sh"]
    secrets:
      - postgres_user
      - postgres_password
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$(cat /run/secrets/postgres_user) -d spectrastrike"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - core_net

  redis:
    image: redis:7.4.2-alpine
    container_name: spectrastrike_redis
    init: true
    command: ["/usr/local/bin/start-redis-tls.sh"]
    volumes:
      - redis_data:/data
      - ./docker/pki:/etc/redis/pki:ro
      - ./docker/scripts/start_redis_tls.sh:/usr/local/bin/start-redis-tls.sh:ro
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "redis-cli", "--tls", "--cacert", "/etc/redis/pki/ca.crt", "--cert", "/etc/redis/pki/app/client.crt", "--key", "/etc/redis/pki/app/client.key", "-p", "6380", "ping"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - core_net

  nginx:
    image: nginx:1.27.4-alpine
    container_name: spectrastrike_nginx
    init: true
    user: "101:101"
    depends_on:
      rabbitmq:
        condition: service_healthy
      app:
        condition: service_healthy
      ui-web:
        condition: service_healthy
    ports:
      - "127.0.0.1:${HOST_PROXY_HTTP_PORT:-18080}:8080"
      - "127.0.0.1:${HOST_PROXY_TLS_PORT:-18443}:8443"
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/certs:/etc/nginx/certs:ro
    tmpfs:
      - /var/cache/nginx:rw,noexec,nosuid,size=64m,uid=101,gid=101
      - /var/run:rw,noexec,nosuid,size=16m,uid=101,gid=101
      - /tmp:rw,noexec,nosuid,size=16m,uid=101,gid=101
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "-", "https://localhost:8443/healthz"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 15s
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - edge_net
      - core_net

  nmap-tool:
    image: instrumentisto/nmap:7.95
    container_name: spectrastrike_nmap_tool
    init: true
    profiles: ["tools"]
    command: ["sleep", "infinity"]
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=16m
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - tools_net

  metasploit-tool:
    image: metasploitframework/metasploit-framework:6.4.58
    container_name: spectrastrike_metasploit_tool
    init: true
    profiles: ["tools"]
    command: ["sleep", "infinity"]
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - tools_net

  loki:
    image: grafana/loki:3.0.0
    container_name: spectrastrike_loki
    init: true
    command: ["-config.file=/etc/loki/local-config.yml"]
    volumes:
      - ./docker/observability/loki-config.yml:/etc/loki/local-config.yml:ro
      - loki_data:/loki
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:3100/ready"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 15s
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - core_net

  vector:
    image: timberio/vector:0.39.0-debian
    container_name: spectrastrike_vector
    init: true
    depends_on:
      loki:
        condition: service_healthy
    command: ["--config", "/etc/vector/vector.toml"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/observability/vector.toml:/etc/vector/vector.toml:ro
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "vector", "validate", "--no-environment", "/etc/vector/vector.toml"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - core_net

networks:
  edge_net:
    driver: bridge
  core_net:
    driver: bridge
    internal: true
  tools_net:
    driver: bridge
    internal: true

secrets:
  rabbitmq_user:
    file: ./docker/secrets/rabbitmq_user.txt
  rabbitmq_password:
    file: ./docker/secrets/rabbitmq_password.txt
  postgres_user:
    file: ./docker/secrets/postgres_user.txt
  postgres_password:
    file: ./docker/secrets/postgres_password.txt

volumes:
  rabbitmq_data:
  postgres_data:
  redis_data:
  loki_data:
  ui_legal_data:
